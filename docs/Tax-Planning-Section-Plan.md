# Tax Planning Section Plan

> **Status**: ✅ IMPLEMENTED
> **Created**: January 7, 2026
> **Completed**: January 9, 2026
> **Based on**: docs/Plans/Feature-Reorganization-Plan.md (Section 3: TAX PLANNING)

---

## Implementation Summary

All planned features have been implemented:

| Feature | Status | Notes |
|---------|--------|-------|
| Database Schema | ✅ Complete | 4 Prisma models added |
| Advance Tax Calculator | ✅ Complete | Full feature with 234B/234C interest |
| What-If Scenarios | ✅ Complete | Baseline, create/compare, smart suggestions |
| Reports Tab | ✅ Complete | PDF/Excel export, charts, ITR reference |
| E2E Tests | ✅ Complete | 8 test files, 7 page objects |
| Unit Tests | ✅ Complete | 43 tests for advance-tax calculations |

---

## User Decisions Made

| Decision | Choice |
|----------|--------|
| Deductions UI | **Enhance Existing** - Keep entering via Income Sources & Investments pages |
| Advance Tax | **Full Feature** - Quarterly tracking, payment history, 234B/234C interest |
| Scenario Planning | **Full What-If Analysis** - Create/save scenarios, compare up to 3, smart suggestions |
| TDS/Form 26AS | **Deferred** - Not implemented in this phase |

---

## Implemented Tab Structure (6 Tabs)

```
TAX PLANNING PAGE
├── Tab 1: Overview (/dashboard/tax-planning)
├── Tab 2: Calculator (/dashboard/tax-planning/calculator)
├── Tab 3: Deductions (/dashboard/tax-planning/deductions)
├── Tab 4: Advance Tax (/dashboard/tax-planning/advance-tax) [NEW]
├── Tab 5: Scenarios (/dashboard/tax-planning/scenarios) [NEW]
└── Tab 6: Reports (/dashboard/tax-planning/reports) [ENHANCED]
```

---

## Phase 1: Database Schema ✅

### Prisma Models Added

```prisma
// 1. Advance Tax Payment Tracking
model AdvanceTaxEstimate {
  id                    String   @id @default(cuid())
  userId                String
  financialYear         String   // "2024-25"
  selectedRegime        String   @default("NEW")
  totalEstimatedIncome  Float    @default(0)
  incomeBreakdown       Json?
  estimatedDeductions   Float    @default(0)
  totalTDSDeducted      Float    @default(0)
  grossTaxLiability     Float    @default(0)
  netTaxLiability       Float    @default(0)
  advanceTaxRequired    Boolean  @default(false)
  interest234B          Float    @default(0)
  interest234C          Float    @default(0)
  lastCalculatedAt      DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules             AdvanceTaxSchedule[]
  payments              AdvanceTaxPayment[]
  @@unique([userId, financialYear])
}

model AdvanceTaxSchedule {
  id                    String   @id @default(cuid())
  estimateId            String
  quarter               Int      // 1, 2, 3, 4
  dueDate               DateTime
  cumulativePercentage  Float    // 15, 45, 75, 100
  cumulativeAmountDue   Float    @default(0)
  quarterAmountDue      Float    @default(0)
  amountPaid            Float    @default(0)
  shortfall             Float    @default(0)
  status                String   @default("PENDING")
  interest234C          Float    @default(0)
  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  payments              AdvanceTaxPayment[]
  @@unique([estimateId, quarter])
}

model AdvanceTaxPayment {
  id                    String   @id @default(cuid())
  userId                String
  estimateId            String
  scheduleId            String?
  paymentDate           DateTime
  amount                Float
  challanSerialNumber   String
  bsrCode               String
  bankName              String?
  quarter               Int
  financialYear         String
  isVerified            Boolean  @default(false)
  challanDocumentUrl    String?
  notes                 String?
  createdAt             DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  schedule              AdvanceTaxSchedule? @relation(fields: [scheduleId], references: [id])
  @@index([userId, financialYear])
}

// 2. What-If Scenarios
model TaxWhatIfScenario {
  id                      String   @id @default(cuid())
  userId                  String
  financialYear           String
  name                    String
  description             String?
  isBaseline              Boolean  @default(false)
  isAutoGenerated         Boolean  @default(false)
  selectedRegime          String   // 'OLD' | 'NEW'
  incomeAdjustments       Json     @default("{}")
  deductionAdjustments    Json     @default("{}")
  totalGrossIncome        Float    @default(0)
  totalDeductions         Float    @default(0)
  taxableIncome           Float    @default(0)
  totalTaxLiability       Float    @default(0)
  taxDifferenceFromBaseline Float  @default(0)
  percentageSavings       Float    @default(0)
  suggestionReason        String?
  optimizationCategory    String?
  lastCalculatedAt        DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, financialYear, name])
  @@index([userId, financialYear])
}
```

### User Model Relations Added
```prisma
// Added to User model
advanceTaxEstimates    AdvanceTaxEstimate[]
advanceTaxPayments     AdvanceTaxPayment[]
taxWhatIfScenarios     TaxWhatIfScenario[]
```

---

## Phase 2: Advance Tax Calculator ✅

### Backend Routes Implemented

**File: `server/routes/advance-tax.ts`**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/advance-tax` | List estimates (filter by FY) |
| POST | `/api/advance-tax` | Create estimate for FY |
| GET | `/api/advance-tax/:id` | Get single estimate with schedules |
| PUT | `/api/advance-tax/:id` | Update estimate |
| DELETE | `/api/advance-tax/:id` | Delete estimate |
| POST | `/api/advance-tax/:id/calculate` | Recalculate tax & schedules |
| GET | `/api/advance-tax/:id/payments` | List payments for estimate |
| POST | `/api/advance-tax/:id/payments` | Add payment with challan details |
| PUT | `/api/advance-tax/:id/payments/:paymentId` | Update payment |
| DELETE | `/api/advance-tax/:id/payments/:paymentId` | Delete payment |
| GET | `/api/advance-tax/:id/interest` | Calculate 234B/234C interest |

### Calculation Logic Implemented

**File: `server/lib/calculations/advance-tax.ts`**

```typescript
export const ADVANCE_TAX_CONFIG = {
  THRESHOLD: 10000,  // Advance tax required if > ₹10K
  QUARTERLY_PERCENTAGES: { Q1: 15, Q2: 45, Q3: 75, Q4: 100 },
  DUE_DATES: {
    Q1: { month: 6, day: 15 },   // June 15
    Q2: { month: 9, day: 15 },   // September 15
    Q3: { month: 12, day: 15 },  // December 15
    Q4: { month: 3, day: 15 },   // March 15
  },
  INTEREST_RATE: 0.01,  // 1% per month
  THRESHOLD_234B: 90,   // Interest if paid < 90%
  DEFERMENT_MONTHS: { Q1: 3, Q2: 3, Q3: 3, Q4: 1 },
}

// Exported functions:
export function getAdvanceTaxDueDates(financialYear: string): AdvanceTaxDueDate[]
export function isAdvanceTaxApplicable(netTaxLiability: number): boolean
export function calculateQuarterlySchedule(netTax: number, fy: string, payments: []): QuarterlySchedule[]
export function calculateInterest234B(totalTax: number, totalPaid: number, assessmentDate: Date): Interest234BResult
export function calculateInterest234C(schedules: QuarterlySchedule[]): Interest234CResult
export function detectQuarterFromPaymentDate(paymentDate: Date, fy: string): 1 | 2 | 3 | 4
export function calculateAdvanceTaxAnalysis(netTax: number, fy: string, payments: [], assessmentDate?: Date): AdvanceTaxCalculationResult
export function formatINR(amount: number): string
```

### Frontend Components Implemented

| File | Description |
|------|-------------|
| `src/pages/dashboard/tax-planning/advance-tax.vue` | Main Advance Tax page |
| `src/components/tax/AdvanceTaxTimeline.vue` | Quarterly timeline visualization |
| `src/components/tax/AdvanceTaxPaymentForm.vue` | Payment entry dialog |
| `src/components/tax/InterestCalculator.vue` | 234B/234C interest display |

---

## Phase 3: What-If Scenario Analysis ✅

### Backend Routes Implemented

**File: `server/routes/tax-scenarios.ts`**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/tax-planning/scenarios` | List scenarios (filter by FY) |
| POST | `/api/tax-planning/scenarios` | Create scenario |
| GET | `/api/tax-planning/scenarios/:id` | Get single scenario |
| PUT | `/api/tax-planning/scenarios/:id` | Update scenario |
| DELETE | `/api/tax-planning/scenarios/:id` | Delete scenario |
| POST | `/api/tax-planning/scenarios/baseline` | Create/update baseline |
| POST | `/api/tax-planning/scenarios/compare` | Compare up to 3 scenarios |
| GET | `/api/tax-planning/scenarios/smart-suggestions` | Generate auto suggestions |

### Smart Suggestion Categories

```typescript
export const SUGGESTION_CATEGORIES = {
  MAX_80C: {
    name: 'Maximize 80C',
    description: 'Utilize full ₹1.5L limit under Section 80C',
  },
  MAX_NPS: {
    name: 'Add NPS',
    description: 'Add ₹50K NPS under 80CCD(1B)',
  },
  MAX_80D: {
    name: 'Health Insurance',
    description: 'Add health insurance under 80D',
  },
  REGIME_SWITCH: {
    name: 'Switch Regime',
    description: 'Compare with opposite tax regime',
  },
  COMBINED_OPTIMAL: {
    name: 'Optimal Strategy',
    description: 'Best combination of all deductions',
  },
}
```

### Frontend Components Implemented

| File | Description |
|------|-------------|
| `src/pages/dashboard/tax-planning/scenarios.vue` | Main Scenarios page |
| `src/components/tax/ScenarioCard.vue` | Scenario display card |
| `src/components/tax/ScenarioEditor.vue` | Create/edit scenario dialog |
| `src/components/tax/ScenarioComparison.vue` | Side-by-side comparison |
| `src/components/tax/SmartSuggestions.vue` | AI-powered suggestions |

---

## Phase 4: Reports Tab ✅

### Backend Routes Implemented

**File: `server/routes/tax-reports.ts`**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/tax-planning/reports` | Get report data for FY |
| GET | `/api/tax-planning/reports/yoy` | Get multi-year comparison |
| POST | `/api/tax-planning/reports/export` | Generate PDF or Excel |

### Frontend Components Implemented

**File: `src/pages/dashboard/tax-planning/reports.vue`**

Features:
- Financial Year selector
- Export buttons (PDF, Excel)
- 4 report tabs:
  - Tax Summary (summary cards, tax distribution chart, tax summary table)
  - Regime Comparison (bar chart, detailed comparison table, savings alert)
  - Deduction Utilization (stacked bar chart, section-wise summary)
  - Advance Tax (schedule summary, quarterly table)
- ITR Form Reference section

---

## Phase 5: Testing ✅

### E2E Page Objects Created

| File | Description |
|------|-------------|
| `e2e/pages/tax-planning/overview.page.ts` | Overview page interactions |
| `e2e/pages/tax-planning/calculator.page.ts` | Calculator page interactions |
| `e2e/pages/tax-planning/deductions.page.ts` | Deductions page interactions |
| `e2e/pages/tax-planning/regime-comparison.page.ts` | Regime comparison interactions |
| `e2e/pages/tax-planning/advance-tax.page.ts` | Advance Tax page interactions |
| `e2e/pages/tax-planning/scenarios.page.ts` | Scenarios page interactions |
| `e2e/pages/tax-planning/reports.page.ts` | Reports page interactions |

### E2E Tests Created

| File | Tests | Description |
|------|-------|-------------|
| `01-navigation.spec.ts` | 9 | Tab navigation, URL routing |
| `02-regime-comparison.spec.ts` | 8 | Old vs New regime comparison |
| `03-calculator.spec.ts` | 12 | Tax calculation inputs |
| `04-deductions.spec.ts` | 10 | Deduction categories |
| `05-itr-recommendation.spec.ts` | 6 | ITR form suggestions |
| `06-reports.spec.ts` | 34 | Reports tabs, export buttons, charts |
| `07-advance-tax.spec.ts` | 21 | Timeline, payments, interest |
| `08-scenarios.spec.ts` | 32 | Baseline, scenarios, comparison |

### Unit Tests Created

**File: `server/lib/calculations/advance-tax.spec.ts`** - 43 tests

| Test Suite | Tests | Description |
|------------|-------|-------------|
| ADVANCE_TAX_CONFIG | 5 | Configuration constants |
| getAdvanceTaxDueDates | 3 | Due date calculations |
| isAdvanceTaxApplicable | 4 | Threshold logic |
| calculateQuarterlySchedule | 7 | Schedule with payments |
| calculateInterest234B | 5 | Default interest calculation |
| calculateInterest234C | 3 | Deferment interest |
| detectQuarterFromPaymentDate | 6 | Quarter detection |
| calculateAdvanceTaxAnalysis | 5 | Complete analysis |
| formatINR | 5 | Currency formatting |

---

## Files Summary

### Created Files

| Category | Files |
|----------|-------|
| **Backend Routes** | `server/routes/advance-tax.ts`, `server/routes/tax-scenarios.ts`, `server/routes/tax-reports.ts` |
| **Calculation Logic** | `server/lib/calculations/advance-tax.ts` |
| **Vue Pages** | `src/pages/dashboard/tax-planning/advance-tax.vue`, `src/pages/dashboard/tax-planning/scenarios.vue` |
| **Vue Components** | `src/components/tax/AdvanceTaxTimeline.vue`, `src/components/tax/AdvanceTaxPaymentForm.vue`, `src/components/tax/InterestCalculator.vue`, `src/components/tax/ScenarioCard.vue`, `src/components/tax/ScenarioEditor.vue`, `src/components/tax/ScenarioComparison.vue`, `src/components/tax/SmartSuggestions.vue` |
| **E2E Page Objects** | `e2e/pages/tax-planning/advance-tax.page.ts`, `e2e/pages/tax-planning/scenarios.page.ts`, `e2e/pages/tax-planning/reports.page.ts` |
| **E2E Tests** | `e2e/tests/tax-planning/07-advance-tax.spec.ts`, `e2e/tests/tax-planning/08-scenarios.spec.ts` |
| **Unit Tests** | `server/lib/calculations/advance-tax.spec.ts` |

### Modified Files

| File | Changes |
|------|---------|
| `prisma/schema.prisma` | Added 4 models + User relations |
| `server/index.ts` | Registered 3 new route files |
| `src/pages/dashboard/tax-planning/index.vue` | Updated tabs array (4→6) |
| `src/pages/dashboard/tax-planning/reports.vue` | Added export functionality |
| `src/composables/useTax.ts` | Added hooks for scenarios, advance tax |
| `e2e/pages/tax-planning/overview.page.ts` | Added new tab locators |
| `e2e/pages/tax-planning/index.ts` | Exported new page objects |
| `e2e/tests/tax-planning/01-navigation.spec.ts` | Updated for 6 tabs |
| `e2e/tests/tax-planning/06-reports.spec.ts` | Comprehensive reports tests |

---

## Not Implemented (Deferred)

These features were intentionally deferred:

- `TDSEntry` Prisma model (Form 26AS placeholder)
- Form 26AS manual entry UI
- TRACES API integration
- TDS reconciliation features

These can be added in a future phase when demand is validated.

---

## Verification Commands

```bash
# Run unit tests
npm run test:unit -- server/lib/calculations/advance-tax.spec.ts

# Run E2E tests for tax planning
npm run test:e2e -- e2e/tests/tax-planning/

# Open Prisma Studio to verify models
npm run db:studio

# Start dev server and verify tabs
npm run dev
# Navigate to http://localhost:5173/dashboard/tax-planning
```

---

## Related Plan Documents

1. `docs/Plans/Feature-Reorganization-Plan.md` - Master navigation
2. `docs/Salary-Section-Plan.md` - Salary component tracking
3. `docs/Non-Salary-Income-Plan.md` - Income section plan
4. **`docs/Tax-Planning-Section-Plan.md`** - This plan (COMPLETE)

---

**Status: ✅ IMPLEMENTATION COMPLETE**
