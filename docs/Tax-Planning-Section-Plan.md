# Tax Planning Section Plan

> **Status**: Ready for Implementation
> **Created**: January 7, 2026
> **Based on**: docs/Plans/Feature-Reorganization-Plan.md (Section 3: TAX PLANNING)
> **Estimated Effort**: ~12.5 days

---

## User Decisions Made

| Decision | Choice |
|----------|--------|
| Deductions UI | **Enhance Existing** - Keep entering via Income Sources & Investments pages |
| Advance Tax | **Full Feature** - Quarterly tracking, payment history, 234B/234C interest |
| Scenario Planning | **Full What-If Analysis** - Create/save scenarios, compare up to 3, smart suggestions |
| TDS/Form 26AS | **Plan for Future** - Database schema + UI placeholders, manual entry only |

---

## Current State vs Target State

### Already Implemented (Keep/Enhance)
- Tax Calculator (Old vs New regime) - `/dashboard/tax-planning`
- ITR Form Recommendation - `/api/tax-planning/itr-summary`
- Basic Tax Optimization Tips - `/api/tax-planning/optimization`
- Multi-source Income Aggregation - 7 income types supported

### New Features to Add
1. **Advance Tax Calculator** - Quarterly deadlines, payment tracking, interest calculation
2. **What-If Scenarios** - Create/compare multiple tax scenarios
3. **Reports Tab** - PDF/Excel export, YoY comparison, charts
4. **Form 26AS Placeholder** - Schema ready for future TDS integration

---

## Updated Tab Structure (6 Tabs)

```
TAX PLANNING PAGE
├── Tab 1: Overview (EXISTING - Minor Enhancement)
├── Tab 2: Income Sources (EXISTING - Keep As-Is)
├── Tab 3: Regime Comparison (EXISTING - Keep As-Is)
├── Tab 4: Advance Tax (NEW)
├── Tab 5: Scenarios (NEW)
└── Tab 6: Reports (NEW)
```

---

## Phase 1: Database Schema (Day 1)

### New Prisma Models

```prisma
// 1. Advance Tax Payment Tracking
model AdvanceTaxEstimate {
  id                    String   @id @default(cuid())
  userId                String
  financialYear         String   // "2024-25"
  selectedRegime        String   @default("NEW")
  totalEstimatedIncome  Float    @default(0)
  incomeBreakdown       Json?
  estimatedDeductions   Float    @default(0)
  totalTDSDeducted      Float    @default(0)
  grossTaxLiability     Float    @default(0)
  netTaxLiability       Float    @default(0)
  advanceTaxRequired    Boolean  @default(false)
  interest234B          Float    @default(0)
  interest234C          Float    @default(0)
  lastCalculatedAt      DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules             AdvanceTaxSchedule[]
  payments              AdvanceTaxPayment[]
  @@unique([userId, financialYear])
}

model AdvanceTaxSchedule {
  id                    String   @id @default(cuid())
  estimateId            String
  quarter               Int      // 1, 2, 3, 4
  dueDate               DateTime
  cumulativePercentage  Float    // 15, 45, 75, 100
  cumulativeAmountDue   Float    @default(0)
  quarterAmountDue      Float    @default(0)
  amountPaid            Float    @default(0)
  shortfall             Float    @default(0)
  status                String   @default("PENDING")
  interest234C          Float    @default(0)
  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  payments              AdvanceTaxPayment[]
  @@unique([estimateId, quarter])
}

model AdvanceTaxPayment {
  id                    String   @id @default(cuid())
  userId                String
  estimateId            String
  scheduleId            String?
  paymentDate           DateTime
  amount                Float
  challanSerialNumber   String
  bsrCode               String
  bankName              String?
  quarter               Int
  financialYear         String
  isVerified            Boolean  @default(false)
  challanDocumentUrl    String?
  notes                 String?
  createdAt             DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  schedule              AdvanceTaxSchedule? @relation(fields: [scheduleId], references: [id])
  @@index([userId, financialYear])
}

// 2. What-If Scenarios
model TaxWhatIfScenario {
  id                      String   @id @default(cuid())
  userId                  String
  financialYear           String
  name                    String
  description             String?
  isBaseline              Boolean  @default(false)
  isAutoGenerated         Boolean  @default(false)
  selectedRegime          String   // 'OLD' | 'NEW'
  incomeAdjustments       Json     @default("{}")
  deductionAdjustments    Json     @default("{}")
  totalGrossIncome        Float    @default(0)
  totalDeductions         Float    @default(0)
  taxableIncome           Float    @default(0)
  totalTaxLiability       Float    @default(0)
  taxDifferenceFromBaseline Float  @default(0)
  percentageSavings       Float    @default(0)
  suggestionReason        String?
  optimizationCategory    String?
  lastCalculatedAt        DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, financialYear, name])
  @@index([userId, financialYear])
}

// 3. TDS Entries (Future - Placeholder)
model TDSEntry {
  id              String   @id @default(cuid())
  userId          String
  financialYear   String
  deductorName    String
  deductorTAN     String?
  tdsSection      String   // 192, 194A, etc.
  grossAmount     Float
  tdsDeducted     Float
  dateOfDeduction DateTime?
  isVerified      Boolean  @default(false)
  source          String   @default("MANUAL")
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, financialYear])
}
```

### User Model Relations to Add
```prisma
// Add to User model
advanceTaxEstimates    AdvanceTaxEstimate[]
advanceTaxPayments     AdvanceTaxPayment[]
taxWhatIfScenarios     TaxWhatIfScenario[]
tdsEntries             TDSEntry[]
```

### Files to Modify
- `prisma/schema.prisma` - Add above models + User relations
- Run: `npx prisma migrate dev --name add_tax_planning_features`

---

## Phase 2: Advance Tax Calculator (Days 2-4)

### UI Wireframe
```
+----------------------------------------------------------------+
| ADVANCE TAX - FY 2024-25                                        |
+----------------------------------------------------------------+
| [Summary Cards]                                                 |
| +------------+ +------------+ +------------+ +------------+     |
| | Est. Tax   | | Paid       | | Remaining  | | Interest   |     |
| | Rs3,45,000 | | Rs1,55,250 | | Rs1,89,750 | | Rs2,340    |     |
| +------------+ +------------+ +------------+ +------------+     |
+----------------------------------------------------------------+
| [Quarterly Timeline]                                            |
| Jun 15    Sep 15    Dec 15    Mar 15                           |
|   15%       45%       75%      100%                            |
|  [PAID]   [PAID]   [DUE]    [UPCOMING]                         |
+----------------------------------------------------------------+
| [Payment History]                        [+ Add Payment]        |
| Date      | Amount    | Quarter | Challan      | Status        |
| 14-Jun-24 | Rs51,750  | Q1      | CRN123456    | Verified      |
+----------------------------------------------------------------+
| [Interest Calculator - 234B/234C]                               |
| Shortfall: Rs1,89,750 | Interest: Rs2,340                      |
+----------------------------------------------------------------+
```

### New Files to Create
```
src/lib/calculations/advance-tax.ts           # Core calculation logic
src/lib/config/financial-constants.ts         # Add ADVANCE_TAX_CONFIG
src/app/api/advance-tax/
  route.ts                                    # GET/POST estimates
  [estimateId]/
    route.ts                                  # GET/PUT/DELETE
    calculate/route.ts                        # POST recalculate
    payments/route.ts                         # GET/POST payments
    payments/[paymentId]/route.ts             # PUT/DELETE payment
    interest/route.ts                         # GET interest calc
    interest/what-if/route.ts                 # POST what-if
src/components/tax-planning/
  AdvanceTaxTab.tsx                           # Main tab component
  AdvanceTaxTimeline.tsx                      # Quarterly timeline
  AdvanceTaxPaymentForm.tsx                   # Add payment modal
  InterestCalculator.tsx                      # 234B/234C display
```

### Calculation Constants
```typescript
// Add to src/lib/config/financial-constants.ts
export const ADVANCE_TAX_CONFIG = {
  THRESHOLD: 10000,  // Advance tax required if > Rs10K
  QUARTERLY_PERCENTAGES: { Q1: 15, Q2: 45, Q3: 75, Q4: 100 },
  DUE_DATES: {
    Q1: { month: 6, day: 15 },   // June 15
    Q2: { month: 9, day: 15 },   // September 15
    Q3: { month: 12, day: 15 },  // December 15
    Q4: { month: 3, day: 15 },   // March 15
  },
  INTEREST_RATE: 0.01,  // 1% per month
  THRESHOLD_234B: 90,   // Interest if paid < 90%
  DEFERMENT_MONTHS: { Q1: 3, Q2: 3, Q3: 3, Q4: 1 },
} as const;
```

### Key Calculation Functions
```typescript
// src/lib/calculations/advance-tax.ts
export function getAdvanceTaxDueDates(financialYear: string): AdvanceTaxDueDate[];
export function calculateQuarterlySchedule(params: {...}): QuarterlySchedule[];
export function calculateInterest234B(params: {...}): Interest234BResult;
export function calculateInterest234C(params: {...}): Interest234CResult;
export function isAdvanceTaxApplicable(netTaxLiability: number): boolean;
export function detectQuarterFromPaymentDate(paymentDate: Date, fy: string): string;
```

---

## Phase 3: What-If Scenario Analysis (Days 5-8)

### UI Wireframe
```
+----------------------------------------------------------------+
| TAX SCENARIOS                                  [+ New Scenario] |
+----------------------------------------------------------------+
| +------------------+ +------------------+ +------------------+  |
| | BASELINE         | | Max 80C          | | Regime Switch    |  |
| | (Current)        | | +Rs1L to 80C     | | OLD regime       |  |
| | Tax: Rs3,00,000  | | Tax: Rs2,70,000  | | Tax: Rs2,40,000  |  |
| | [Locked]         | | Saves: Rs30,000  | | Saves: Rs60,000  |  |
| +------------------+ +------------------+ +------------------+  |
+----------------------------------------------------------------+
| COMPARISON TABLE                                                |
| Parameter      | Baseline | Max 80C  | Regime Switch           |
| --------------|----------|----------|------------------------- |
| Gross Income   | Rs30L    | Rs30L    | Rs30L                   |
| 80C Deductions | Rs50K    | Rs1.5L   | Rs1.5L                  |
| Taxable Income | Rs28.5L  | Rs27.5L  | Rs26.5L                 |
| Tax Payable    | Rs3L     | Rs2.7L   | Rs2.4L                  |
| SAVINGS        | -        | Rs30K    | Rs60K (BEST)            |
+----------------------------------------------------------------+
| SMART SUGGESTIONS                                               |
| [Optimal: Max 80C + Max NPS + HRA] Tax: Rs2.1L - Saves Rs90K   |
+----------------------------------------------------------------+
```

### New Files to Create
```
src/services/tax/TaxScenarioService.ts        # Business logic
src/lib/calculations/tax-scenario-optimizer.ts # Smart suggestions
src/types/tax-scenario.ts                      # TypeScript types
src/app/api/tax-planning/scenarios/
  route.ts                                     # GET/POST scenarios
  [id]/route.ts                                # GET/PUT/DELETE
  baseline/route.ts                            # Create/update baseline
  compare/route.ts                             # POST compare up to 3
  smart-suggestions/route.ts                   # GET auto suggestions
src/components/tax-scenarios/
  ScenarioCard.tsx                             # Scenario display card
  ScenarioEditor.tsx                           # Edit modal/sheet
  ScenarioComparison.tsx                       # Side-by-side view
  SmartSuggestions.tsx                         # Auto suggestions
  IncomeAdjustmentForm.tsx                     # Income inputs
  DeductionAdjustmentForm.tsx                  # Deduction inputs
src/hooks/useTaxScenarios.ts                   # React Query hooks
```

### Smart Suggestion Categories
1. `MAX_80C` - Maximize Section 80C to Rs1.5L
2. `MAX_NPS` - Add Rs50K NPS under 80CCD(1B)
3. `MAX_80D` - Add health insurance
4. `REGIME_SWITCH` - Switch Old<->New regime
5. `COMBINED_OPTIMAL` - Best combination of all

### Deduction Limits
```typescript
const DEDUCTION_LIMITS = {
  section80C: 150000,
  section80D: 25000,       // 50000 for senior citizens
  section80DParents: 50000, // For senior citizen parents
  section80CCD1B: 50000,
  section80TTA: 10000,
  section24: 200000,
  // No limit: section80E, section80G
};
```

---

## Phase 4: Reports Tab (Days 9-10)

### UI Wireframe
```
+----------------------------------------------------------------+
| TAX REPORTS                                                     |
+----------------------------------------------------------------+
| [Report Types]                                                  |
| [Tax Summary] [Regime Comparison] [Deduction Breakdown] [YoY]  |
+----------------------------------------------------------------+
| [Charts]                                                        |
| +---------------------------+ +-------------------------------+ |
| | Income Distribution (Pie) | | Tax Trend - 3 Years (Line)    | |
| +---------------------------+ +-------------------------------+ |
+----------------------------------------------------------------+
| [Export Options]                                                |
| [PDF] [Excel] [CSV]                           [Generate Report] |
+----------------------------------------------------------------+
| [Form 26AS - Coming Soon]                                       |
| Manual TDS entry placeholder for future integration             |
+----------------------------------------------------------------+
```

### New Files to Create
```
src/components/tax-planning/
  TaxReportsTab.tsx                            # Main reports tab
  TaxSummaryReport.tsx                         # Summary report
  DeductionUtilizationChart.tsx                # 80C/80D utilization
  YoYComparisonChart.tsx                       # Year-over-year
  Form26ASPlaceholder.tsx                      # Future TDS UI
src/app/api/tax-planning/reports/
  route.ts                                     # GET report data
  yoy-comparison/route.ts                      # GET multi-year data
  export/route.ts                              # POST generate PDF/Excel
src/lib/reports/
  tax-summary-generator.ts                     # PDF generation
  tax-report-excel.ts                          # Excel export
```

---

## Phase 5: Integration & Testing (Days 11-12)

### Main Page Update
Modify `src/app/dashboard/tax-planning/page.tsx`:
- Add 3 new tabs (Advance Tax, Scenarios, Reports)
- Add navigation links between tabs
- Update Overview tab with alerts/widgets

### Tests to Create
```
tests/e2e/tax-planning-advance-tax.spec.ts    # Advance tax E2E
tests/e2e/tax-planning-scenarios.spec.ts      # Scenarios E2E
tests/e2e/tax-planning-reports.spec.ts        # Reports E2E
tests/unit/advance-tax.test.ts                # Calculation unit tests
tests/unit/tax-scenario-optimizer.test.ts     # Optimizer unit tests
```

---

## Implementation Order Summary

| Phase | Feature | Days | Priority |
|-------|---------|------|----------|
| 1 | Database Schema & Migrations | 0.5 | P0 |
| 2 | Advance Tax Calculator | 3 | P1 |
| 3 | What-If Scenario Analysis | 4 | P1 |
| 4 | Reports Tab | 2 | P1 |
| 5 | Overview Tab Enhancements | 0.5 | P2 |
| 6 | Testing & Polish | 2.5 | P1 |
| **Total** | | **12.5 days** | |

---

## Critical Files Summary

### Must Create
1. `prisma/schema.prisma` - Add 5 new models
2. `src/lib/calculations/advance-tax.ts` - Core advance tax logic
3. `src/services/tax/TaxScenarioService.ts` - Scenario business logic
4. `src/app/api/advance-tax/*` - 8+ API routes
5. `src/app/api/tax-planning/scenarios/*` - 6 API routes
6. `src/components/tax-planning/*` - 12+ new components

### Must Modify
1. `src/app/dashboard/tax-planning/page.tsx` - Add 3 new tabs
2. `src/lib/config/financial-constants.ts` - Add ADVANCE_TAX_CONFIG
3. `src/types/salary.ts` - Add new type exports

---

## Open Questions (Resolved)

| Question | Decision |
|----------|----------|
| Deductions separate page? | No - use existing flows |
| Advance tax complexity? | Full feature with interest calc |
| Scenario limit? | 10 per user per FY |
| Form 26AS integration? | Schema only, manual entry |

---

## Related Plan Documents
1. `docs/Plans/Feature-Reorganization-Plan.md` - Master navigation
2. `docs/Plans/Salary-Section-Plan.md` - Salary component tracking
3. `docs/Plans/Non-Salary-Income-Plan.md` - Income section plan
4. **`docs/Plans/Tax-Planning-Section-Plan.md`** - This plan

---

**Status: READY FOR IMPLEMENTATION**
