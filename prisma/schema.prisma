// FIREKaro-Vue Prisma Schema
// Core models extracted from FIREKaro for Salary, Investments, Liabilities, Financial Health

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION MODELS (Better Auth compatible)
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth relations
  accounts      Account[]
  sessions      Session[]

  // Profile
  profile       Profile?

  // Family
  familyMembers FamilyMember[]

  // Salary relations
  incomeSources              IncomeSource[]
  monthlySalaries            MonthlySalary[]
  salaryComponentDefinitions SalaryComponentDefinition[]

  // Investment relations
  investments            Investment[]
  investmentTransactions InvestmentTransaction[]
  investmentGoals        InvestmentGoal[]
  epfAccount             EPFAccount?
  ppfAccounts            PPFAccount[]
  npsAccounts            NPSAccount[]
  esopGrants             ESOPGrant[]
  portfolio              Portfolio[]

  // Liabilities relations
  loans          Loan[]
  loanPayments   LoanPayment[]
  debtPayoffPlans DebtPayoffPlan[]
  creditCards    CreditCard[]

  // Financial Health relations
  netWorth               NetWorth[]
  monthlySnapshots       MonthlyFinancialSnapshot[]
  bankAccounts           BankAccount[]
  emergencyFund          EmergencyFund?
  financialGoals         FinancialGoal[]

  // Non-Salary Income relations
  businessIncomes        BusinessIncome[]
  rentalIncomes          RentalIncome[]
  capitalGains           CapitalGain[]
  interestIncomes        InterestIncome[]
  dividendIncomes        DividendIncome[]
  otherIncomes           OtherIncome[]

  // Expense relations
  expenses               Expense[]
  budgets                Budget[]
  expenseCategories      ExpenseCategory[]
  expenseCategoryRules   ExpenseCategoryRule[]
  alertPreferences       AlertPreference?
  alertDeliveries        AlertDelivery[]

  // Tax Planning relations
  advanceTaxEstimates    AdvanceTaxEstimate[]
  advanceTaxPayments     AdvanceTaxPayment[]
  taxWhatIfScenarios     TaxWhatIfScenario[]

  // Protection/Insurance relations
  insurancePolicies      InsurancePolicy[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  idToken           String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ============================================================================
// USER PROFILE
// ============================================================================

model Profile {
  id                  String    @id @default(cuid())
  userId              String    @unique
  dateOfBirth         DateTime?
  occupation          String?
  city                String?
  targetRetirementAge Int?
  currentAge          Int?
  monthlyExpenses     Float     @default(0)
  monthlyIncome       Float     @default(0)
  currentSavings      Float     @default(0)
  riskTolerance       String?
  investmentStyle     String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// FAMILY MEMBERS
// ============================================================================

enum FamilyRelationship {
  SELF
  SPOUSE
  FATHER
  MOTHER
  SON
  DAUGHTER
  FATHER_IN_LAW
  MOTHER_IN_LAW
  BROTHER
  SISTER
  GRANDFATHER
  GRANDMOTHER
  OTHER
}

model FamilyMember {
  id           String             @id @default(cuid())
  userId       String
  relationship FamilyRelationship
  name         String
  dateOfBirth  DateTime?
  gender       String?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditCards CreditCard[]

  @@index([userId])
}

// ============================================================================
// SALARY & INCOME MODELS
// ============================================================================

enum IncomeSourceType {
  SALARY
  BUSINESS
  PROFESSION
  HOUSE_PROPERTY
  CAPITAL_GAINS
  OTHER_SOURCES
}

enum IncomeSourceStatus {
  ACTIVE
  INACTIVE
}

// Dynamic Salary Component Enums
enum SalaryComponentType {
  EARNING
  DEDUCTION
  EMPLOYER_CONTRIBUTION
}

enum SyncTargetType {
  EPF
  VPF
  NPS_EMPLOYEE
  NPS_EMPLOYER
  SUPERANNUATION
  PENSION_FUND
  NONE
}

enum SyncDirection {
  FROM_SALARY        // Salary is source of truth
  TO_SALARY          // Other section is source
  BIDIRECTIONAL      // Both ways (with conflict resolution)
  MANUAL             // No auto-sync
}

enum SyncStatus {
  PENDING            // Not yet synced
  SYNCED             // Successfully synced to target
  CONFLICT           // Conflict detected, needs resolution
  SKIPPED            // User chose not to sync
}

model IncomeSource {
  id            String             @id @default(cuid())
  userId        String
  sourceType    IncomeSourceType
  sourceName    String
  description   String?
  financialYear String             @default("2024-25")
  status        IncomeSourceStatus @default(ACTIVE)
  isPrimary     Boolean            @default(false)
  displayOrder  Int                @default(0)
  grossIncome   Float              @default(0)
  deductions    Float              @default(0)
  taxableIncome Float              @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthlySalaries  MonthlySalary[]
  salaryStructures SalaryStructure[]

  @@index([userId, financialYear])
  @@index([userId, sourceType])
}

model MonthlySalary {
  id             String  @id @default(cuid())
  userId         String
  financialYear  String
  month          Int     // 1-12 (1=April, 12=March)
  year           Int     // Calendar year
  incomeSourceId String?
  employerName   String?
  designation    String?
  paidDays       Int     @default(30)

  // Earnings
  basicSalary          Float @default(0)
  dearnessAllowance    Float @default(0)
  houseRentAllowance   Float @default(0)
  conveyanceAllowance  Float @default(0)
  medicalAllowance     Float @default(0)
  leaveTravelAllowance Float @default(0)
  childrenEducation    Float @default(0)
  carAllowance         Float @default(0)
  incentives           Float @default(0)
  miscellaneous        Float @default(0)
  otherEarnings        Json?

  // Deductions
  professionalTax Float @default(0)
  employeePF      Float @default(0)
  voluntaryPF     Float @default(0)
  incomeTax       Float @default(0)
  otherTaxes      Float @default(0)
  superannuation  Float @default(0)
  npsContribution Float @default(0)
  otherDeductions Json?

  // Employer Contributions
  pensionFund             Float @default(0)
  employerPF              Float @default(0)
  otherEmployerDeductions Float @default(0)

  // Computed Totals
  grossSalary     Float @default(0)
  totalDeductions Float @default(0)
  netSalary       Float @default(0)

  // Sync Tracking
  syncStatus   String?   @default("PENDING")
  lastSyncedAt DateTime?
  syncedToEpf  Boolean   @default(false)
  syncedToNps  Boolean   @default(false)
  syncError    String?

  // Metadata
  isVerified Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  incomeSource IncomeSource? @relation(fields: [incomeSourceId], references: [id])
  componentEntries SalaryComponentEntry[]

  @@unique([userId, financialYear, month, incomeSourceId])
  @@index([userId, financialYear])
  @@index([incomeSourceId])
  @@index([syncStatus])
}

// Salary Component Definition - Master table for dynamic components
model SalaryComponentDefinition {
  id              String              @id @default(cuid())
  code            String              // "BASIC", "HRA", "VPF"
  name            String              // "Basic Salary"
  componentType   SalaryComponentType // EARNING, DEDUCTION, EMPLOYER_CONTRIBUTION
  category        String?             // "Fixed", "Variable", "Statutory"

  // Tax Treatment
  isTaxable       Boolean             @default(true)
  taxSection      String?             // "80C", "10(13A)", "80CCD(1B)"
  isExemptUpTo    Float?              // Exemption limit

  // Cross-Section Sync
  syncTarget      SyncTargetType      @default(NONE)
  syncDirection   SyncDirection       @default(FROM_SALARY)

  // Expandable Component Config
  isExpandable    Boolean             @default(false)
  parentCode      String?             // For sub-components (e.g., "OTHER_DED" for VPF)

  // Configuration
  isSystem        Boolean             @default(false)
  isActive        Boolean             @default(true)
  displayOrder    Int                 @default(0)
  userId          String?             // null = system-wide

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user            User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries         SalaryComponentEntry[]

  @@unique([code, userId])
  @@index([componentType])
  @@index([userId])
  @@index([isSystem])
}

// Salary Component Entry - Per-month per-component values
model SalaryComponentEntry {
  id                      String                    @id @default(cuid())
  monthlySalaryId         String
  componentDefinitionId   String
  amount                  Float                     @default(0)
  remarks                 String?

  // Sync Status
  syncedAt                DateTime?
  syncStatus              SyncStatus                @default(PENDING)
  syncError               String?

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  monthlySalary           MonthlySalary             @relation(fields: [monthlySalaryId], references: [id], onDelete: Cascade)
  componentDefinition     SalaryComponentDefinition @relation(fields: [componentDefinitionId], references: [id])

  @@unique([monthlySalaryId, componentDefinitionId])
  @@index([monthlySalaryId])
  @@index([componentDefinitionId])
  @@index([syncStatus])
}

// Salary Structure - For mid-year salary changes (promotion, raise)
model SalaryStructure {
  id               String   @id @default(cuid())
  incomeSourceId   String
  structureName    String   // "Initial", "Post-Promotion Sep 2024"
  effectiveFrom    DateTime // When this structure became active
  effectiveTo      DateTime? // When this structure ended (null = current)

  // Template amounts for auto-fill
  templateData     Json     // { "BASIC": 150000, "HRA": 60000, ... }

  // Metadata
  reason           String?  // "Promotion", "Annual Increment"
  changePercent    Float?   // Percentage change from previous structure
  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  incomeSource     IncomeSource @relation(fields: [incomeSourceId], references: [id], onDelete: Cascade)

  @@index([incomeSourceId])
  @@index([effectiveFrom])
}

// ============================================================================
// INVESTMENT MODELS
// ============================================================================

model Investment {
  id          String  @id @default(cuid())
  userId      String
  name        String
  type        String  // MUTUAL_FUND, STOCK, BOND, FD, RD, SIP, etc.
  category    String  // EQUITY, DEBT, HYBRID, etc.
  subcategory String?
  symbol      String?
  isin        String?
  platform    String?
  folioNumber String?

  // Current status
  totalInvested Float @default(0)
  currentValue  Float @default(0)
  totalUnits    Float @default(0)
  averagePrice  Float @default(0)

  // Performance
  absoluteReturn        Float  @default(0)
  absoluteReturnPercent Float  @default(0)
  xirr                  Float?
  cagr                  Float?

  // SIP details
  isSIP       Boolean   @default(false)
  sipAmount   Float?
  sipDate     Int?
  nextSIPDate DateTime?

  // Tax
  isELSS       Boolean @default(false)
  isTaxSaving  Boolean @default(false)
  lockInPeriod Int?
  maturityDate DateTime?

  // Status
  isActive            Boolean   @default(true)
  firstInvestmentDate DateTime?
  lastTransactionDate DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions InvestmentTransaction[]

  @@index([userId])
  @@index([userId, type])
  @@index([isActive])
}

model InvestmentTransaction {
  id              String   @id @default(cuid())
  userId          String
  investmentId    String
  transactionType String   // BUY, SELL, SIP, DIVIDEND, etc.
  transactionDate DateTime
  units           Float    @default(0)
  price           Float    @default(0)
  amount          Float
  totalCharges    Float    @default(0)
  netAmount       Float
  platform        String?
  orderId         String?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, transactionDate])
  @@index([investmentId])
}

model InvestmentGoal {
  id                String   @id @default(cuid())
  userId            String
  goalName          String
  targetAmount      Float
  targetDate        DateTime
  monthlyInvestment Float
  investmentType    String   @default("HYBRID")
  riskProfile       String   @default("MODERATE")
  currentAmount     Float    @default(0)
  progressPercent   Float    @default(0)
  category          String   @default("PERSONAL")
  priority          String   @default("MEDIUM")
  isActive          Boolean  @default(true)
  isAchieved        Boolean  @default(false)
  achievedAt        DateTime?
  expectedReturn    Float    @default(12.0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}

// EPF Account
model EPFAccount {
  id                   String   @id @default(cuid())
  userId               String   @unique
  uan                  String?
  establishmentCode    String?
  accountNumber        String?
  currentBalance       Float    @default(0)
  employeeShare        Float    @default(0)
  employerShare        Float    @default(0)
  pensionFund          Float    @default(0)
  basicSalary          Float    @default(0)
  employeeContribution Float    @default(0)
  employerEPF          Float    @default(0)
  employerEPS          Float    @default(0)
  vpfContribution      Float    @default(0)
  interestRate         Float    @default(0.0825)
  lastUpdated          DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions EPFTransaction[]

  @@index([userId])
}

model EPFTransaction {
  id              String   @id @default(cuid())
  epfAccountId    String
  transactionType String
  amount          Float
  balance         Float
  description     String?
  transactionDate DateTime
  createdAt       DateTime @default(now())

  epfAccount EPFAccount @relation(fields: [epfAccountId], references: [id], onDelete: Cascade)

  @@index([epfAccountId, transactionDate])
}

// NPS Account
model NPSAccount {
  id                       String   @id @default(cuid())
  userId                   String
  pran                     String?
  subscriberName           String?
  tierType                 String   // Tier I or Tier II
  currentCorpus            Float    @default(0)
  equityAllocation         Float    @default(50)
  corporateDebtAllocation  Float    @default(30)
  governmentBondAllocation Float    @default(20)
  monthlyContribution      Float    @default(0)
  employerContribution     Float    @default(0)
  riskProfile              String   @default("MODERATE")
  lastUpdated              DateTime @default(now())
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions NPSTransaction[]

  @@unique([userId, tierType])
  @@index([userId])
}

model NPSTransaction {
  id              String   @id @default(cuid())
  npsAccountId    String
  transactionType String
  amount          Float
  corpus          Float
  description     String?
  transactionDate DateTime
  createdAt       DateTime @default(now())

  npsAccount NPSAccount @relation(fields: [npsAccountId], references: [id], onDelete: Cascade)

  @@index([npsAccountId, transactionDate])
}

// PPF Account - Public Provident Fund (7.1% interest, 15-year lock-in)
model PPFAccount {
  id                   String    @id @default(cuid())
  userId               String
  accountNumber        String?
  bankName             String?
  branchName           String?
  openingDate          DateTime
  maturityDate         DateTime  // 15 years from opening
  currentBalance       Float     @default(0)
  interestRate         Float     @default(0.071) // 7.1%
  totalDeposited       Float     @default(0)
  totalInterestEarned  Float     @default(0)

  // Annual contribution tracking (max Rs 1.5L per year)
  currentYearDeposit   Float     @default(0)
  maxAnnualDeposit     Float     @default(150000) // Rs 1.5 Lakh

  // Extension tracking (after 15 years)
  isExtended           Boolean   @default(false)
  extensionType        String?   // "WITH_CONTRIBUTION", "WITHOUT_CONTRIBUTION"
  extensionEndDate     DateTime?
  extensionCount       Int       @default(0) // Each extension = 5 years

  // Loan facility (available from 3rd to 6th year)
  loanTaken            Float     @default(0)
  loanOutstanding      Float     @default(0)
  loanInterestRate     Float     @default(0.01) // 1% above PPF rate

  // Partial withdrawal (after 7th year)
  totalWithdrawn       Float     @default(0)

  // Nominee details
  nomineeName          String?
  nomineeRelation      String?

  // Status
  isActive             Boolean   @default(true)
  closedAt             DateTime?
  closureReason        String?   // "MATURITY", "PREMATURE_DEATH", "NRI_STATUS"

  lastUpdated          DateTime  @default(now())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions PPFTransaction[]

  @@index([userId])
  @@index([maturityDate])
}

model PPFTransaction {
  id              String   @id @default(cuid())
  ppfAccountId    String
  transactionType String   // "DEPOSIT", "INTEREST", "PARTIAL_WITHDRAWAL", "LOAN_TAKEN", "LOAN_REPAID", "MATURITY", "CLOSURE"
  amount          Float
  balance         Float    // Balance after this transaction
  financialYear   String   // "2024-25"
  description     String?
  transactionDate DateTime

  // For deposits - track monthly contributions
  depositMonth    Int?     // 1-12 (April = 1)

  // For interest crediting
  interestYear    String?  // Year for which interest was credited

  // For partial withdrawal
  eligibleAmount  Float?   // 50% of balance at end of 4th preceding year

  // For loan
  loanYear        Int?     // Which year loan was taken (3-6)
  loanDueDate     DateTime?

  createdAt       DateTime @default(now())

  ppfAccount PPFAccount @relation(fields: [ppfAccountId], references: [id], onDelete: Cascade)

  @@index([ppfAccountId, transactionDate])
  @@index([financialYear])
}

// ESOP/RSU Grant Model
enum ESOPGrantType {
  ESOP        // Employee Stock Option Plan
  RSU         // Restricted Stock Unit
  RSA         // Restricted Stock Award
  SAR         // Stock Appreciation Right
  PHANTOM     // Phantom Stock
}

enum ESOPGrantStatus {
  ACTIVE
  PARTIALLY_VESTED
  FULLY_VESTED
  EXERCISED
  EXPIRED
  CANCELLED
  FORFEITED
}

enum VestingScheduleType {
  CLIFF           // All vest at once after cliff period
  GRADED          // Vest over time (e.g., 25% per year)
  MILESTONE       // Vest on achievement of milestones
  HYBRID          // Cliff + Graded combination
}

model ESOPGrant {
  id                    String              @id @default(cuid())
  userId                String

  // Grant Details
  grantType             ESOPGrantType
  grantDate             DateTime
  grantNumber           String?             // Company's grant reference
  companyName           String
  companySymbol         String?             // Stock symbol (for listed companies)

  // Option/Unit Details
  totalUnits            Float               // Total options/RSUs granted
  grantPrice            Float               @default(0) // Exercise price (0 for RSUs)
  fairMarketValue       Float               // FMV at grant date
  currentFMV            Float?              // Latest FMV

  // Vesting Details
  vestingScheduleType   VestingScheduleType @default(GRADED)
  vestingStartDate      DateTime
  cliffMonths           Int                 @default(12) // Cliff period in months
  totalVestingMonths    Int                 @default(48) // Total vesting period
  vestingFrequency      Int                 @default(12) // Vest every N months after cliff

  // Current Status
  status                ESOPGrantStatus     @default(ACTIVE)
  vestedUnits           Float               @default(0)
  exercisedUnits        Float               @default(0)
  exercisableUnits      Float               @default(0) // Vested but not yet exercised
  unvestedUnits         Float               @default(0)
  forfeitedUnits        Float               @default(0)

  // Expiry
  expiryDate            DateTime?           // When options expire
  postTerminationExercisePeriod Int?        // Days to exercise after leaving

  // Tax & Valuation
  perquisiteValue       Float?              // Taxable value at vesting (FMV - Exercise Price)
  taxPaid               Float               @default(0)
  section80C_Exemption  Float               @default(0) // If ESOP qualifies

  // Company Status
  isListedCompany       Boolean             @default(false)
  isStartup             Boolean             @default(false)
  startupDPIITNumber    String?             // For eligible startups (tax deferral)

  // Notes
  planName              String?             // ESOP Plan name
  notes                 String?

  lastUpdated           DateTime            @default(now())
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  vestingEvents         ESOPVestingEvent[]

  @@index([userId])
  @@index([status])
  @@index([companyName])
}

model ESOPVestingEvent {
  id                String    @id @default(cuid())
  esopGrantId       String

  // Vesting Details
  vestingDate       DateTime
  unitsVested       Float
  vestingPercentage Float     // What % of total grant this represents

  // Valuation at Vesting
  fmvAtVesting      Float     // Fair Market Value at vesting
  exercisePrice     Float     // Exercise price (from grant)
  perquisiteValue   Float     // (FMV - Exercise Price) * Units

  // Exercise Details (if exercised)
  isExercised       Boolean   @default(false)
  exerciseDate      DateTime?
  unitsExercised    Float?
  salePrice         Float?    // If sold immediately (cashless exercise)

  // Tax
  taxableAmount     Float     @default(0)
  tdsDeducted       Float     @default(0)

  // Status
  status            String    @default("PENDING") // "PENDING", "VESTED", "EXERCISED", "EXPIRED", "FORFEITED"

  // Notes
  description       String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  esopGrant         ESOPGrant @relation(fields: [esopGrantId], references: [id], onDelete: Cascade)

  @@index([esopGrantId])
  @@index([vestingDate])
  @@index([status])
}

model Portfolio {
  id           String    @id @default(cuid())
  userId       String
  name         String
  type         String
  symbol       String?
  quantity     Float
  buyPrice     Float
  currentPrice Float?
  value        Float?
  purchaseDate DateTime?
  platform     String?
  currency     String    @default("INR")
  sector       String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// LIABILITIES MODELS
// ============================================================================

enum LoanType {
  HOME_LOAN
  PERSONAL_LOAN
  CAR_LOAN
  CREDIT_CARD
  EDUCATION_LOAN
  BUSINESS_LOAN
  GOLD_LOAN
  LOAN_AGAINST_PROPERTY
  LOAN_AGAINST_SECURITIES
  OTHER
}

enum LoanStatus {
  ACTIVE
  CLOSED
  DEFAULTED
  FORECLOSED
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

model Loan {
  id                String           @id @default(cuid())
  userId            String
  loanName          String
  loanType          LoanType
  lender            String
  loanAccountNumber String?
  principalAmount   Float
  outstandingAmount Float
  interestRate      Float
  emiAmount         Float
  tenure            Int
  remainingTenure   Int
  loanStartDate     DateTime
  emiStartDate      DateTime
  maturityDate      DateTime
  paymentFrequency  PaymentFrequency @default(MONTHLY)
  nextEmiDate       DateTime?
  lastPaymentDate   DateTime?
  status            LoanStatus       @default(ACTIVE)
  collateralValue   Float?
  processingFee     Float?
  prepaymentCharges Float?
  taxBenefitSection String?
  maxTaxBenefit     Float?
  purpose           String?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments LoanPayment[]

  @@index([userId, status])
  @@index([loanType])
  @@index([nextEmiDate])
}

model LoanPayment {
  id                String   @id @default(cuid())
  userId            String
  loanId            String
  paymentDate       DateTime
  emiNumber         Int?
  principalPaid     Float
  interestPaid      Float
  totalPaid         Float
  outstandingAfter  Float
  paymentMode       String?
  transactionId     String?
  isLateFee         Boolean  @default(false)
  lateFeeAmount     Float    @default(0)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId, paymentDate])
  @@index([userId])
}

model DebtPayoffPlan {
  id                  String    @id @default(cuid())
  userId              String
  planName            String
  strategy            String    // AVALANCHE, SNOWBALL, CUSTOM
  totalDebt           Float
  targetPayoffDate    DateTime?
  monthlyBudget       Float
  totalPaid           Float     @default(0)
  remainingDebt       Float     @default(0)
  interestSaved       Float     @default(0)
  projectedPayoffDate DateTime?
  includedLoans       String[]
  includedCreditCards String[]
  payoffOrder         Json?
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CreditCard {
  id                  String                @id @default(cuid())
  userId              String
  familyMemberId      String?
  cardName            String
  bankName            String
  cardNumber          String                // Masked: ****1234
  cardType            String                // VISA, MASTERCARD, RUPAY, AMEX
  creditLimit         Float
  availableLimit      Float
  currentOutstanding  Float                 @default(0)
  billingCycleDate    Int                   // Day of month (1-31)
  paymentDueDate      Int                   // Day of month (1-31)
  rewardPointsBalance Int                   @default(0)
  interestRateAPR     Float?
  annualFee           Float                 @default(0)
  feeWaiverSpend      Float?
  cardExpiryDate      DateTime?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyMember FamilyMember?         @relation(fields: [familyMemberId], references: [id])
  statements   CreditCardStatement[]

  @@index([userId, isActive])
  @@index([paymentDueDate])
}

model CreditCardStatement {
  id              String     @id @default(cuid())
  creditCardId    String
  statementDate   DateTime
  statementAmount Float
  minimumDue      Float
  dueDate         DateTime
  isPaid          Boolean    @default(false)
  paidAmount      Float?
  paidDate        DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  creditCard CreditCard @relation(fields: [creditCardId], references: [id], onDelete: Cascade)

  @@index([creditCardId, statementDate])
}

// ============================================================================
// FINANCIAL HEALTH MODELS
// ============================================================================

model NetWorth {
  id          String   @id @default(cuid())
  userId      String
  liquid      Float    @default(0)
  equity      Float    @default(0)
  fixed       Float    @default(0)
  property    Float    @default(0)
  other       Float    @default(0)
  liabilities Float    @default(0)
  totalAssets Float    @default(0)
  netWorth    Float    @default(0)
  recordedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt])
}

model MonthlyFinancialSnapshot {
  id            String @id @default(cuid())
  userId        String
  financialYear String
  month         Int
  year          Int

  // Income
  totalIncome       Float @default(0)
  salaryIncome      Float @default(0)
  businessIncome    Float @default(0)
  rentalIncome      Float @default(0)
  investmentIncome  Float @default(0)
  otherIncome       Float @default(0)

  // Expenses
  totalExpenses         Float @default(0)
  essentialExpenses     Float @default(0)
  discretionaryExpenses Float @default(0)
  emiPayments           Float @default(0)
  insurancePremiums     Float @default(0)
  investments           Float @default(0)

  // Net Worth
  totalAssets      Float @default(0)
  totalLiabilities Float @default(0)
  netWorth         Float @default(0)

  // Savings
  monthlySavings Float   @default(0)
  savingsRate    Float   @default(0)
  isActual       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, financialYear, month])
  @@index([userId, financialYear])
}

model BankAccount {
  id             String    @id @default(cuid())
  userId         String
  accountName    String
  bankName       String
  accountNumber  String
  accountType    String    // SAVINGS, CURRENT, SALARY, FD, RD
  currentBalance Float     @default(0)
  interestRate   Float?
  maturityDate   DateTime?
  maturityAmount Float?
  ifscCode       String?
  branchName     String?
  isActive       Boolean   @default(true)
  isPrimary      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountType])
}

model EmergencyFund {
  id                   String   @id @default(cuid())
  userId               String   @unique
  targetMonths         Int      @default(6)
  monthlyExpenses      Float    @default(0)
  targetAmount         Float    @default(0)
  currentAmount        Float    @default(0)
  percentageComplete   Float    @default(0)
  savingsAccountAmount Float    @default(0)
  liquidFundAmount     Float    @default(0)
  fdAmount             Float    @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FinancialGoal {
  id                  String    @id @default(cuid())
  userId              String
  goalName            String
  goalType            String    // RETIREMENT, EDUCATION, HOUSE, etc.
  description         String?
  targetAmount        Float
  targetDate          DateTime
  currentAmount       Float     @default(0)
  monthlyContribution Float     @default(0)
  expectedReturn      Float     @default(12.0)
  priority            String    @default("MEDIUM")
  status              String    @default("IN_PROGRESS")
  linkedInvestments   String[]
  linkedSIPs          String[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ============================================================================
// EXPENSE & BUDGET MODELS
// ============================================================================

enum PaymentMethod {
  UPI
  CREDIT_CARD
  DEBIT_CARD
  CASH
  NET_BANKING
  WALLET
  OTHER
}

enum BudgetCategoryType {
  NEEDS
  WANTS
  SAVINGS
}

model Expense {
  id              String        @id @default(cuid())
  userId          String
  amount          Float
  description     String
  category        String
  subcategory     String?
  date            DateTime
  merchant        String?
  paymentMethod   PaymentMethod @default(OTHER)
  tags            String[]      @default([])
  isRecurring     Boolean       @default(false)
  receiptUrl      String?
  notes           String?

  // AI Categorization tracking
  aiCategorized   Boolean       @default(false)
  aiConfidence    Float?

  // Family member tracking (optional)
  familyMemberId  String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, category])
  @@index([date])
}

model Budget {
  id              String   @id @default(cuid())
  userId          String
  month           Int      // 1-12
  year            Int      // Calendar year
  income          Float

  // 50/30/20 Budget Limits
  needsLimit      Float    // 50% default
  wantsLimit      Float    // 30% default
  savingsLimit    Float    // 20% default

  // Actual spending (computed or tracked)
  needsActual     Float    @default(0)
  wantsActual     Float    @default(0)
  savingsActual   Float    @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId, year])
}

model ExpenseCategory {
  id              String             @id @default(cuid())
  userId          String?            // null = system default
  name            String
  icon            String?            // mdi-icon name
  color           String?            // hex color
  budgetType      BudgetCategoryType @default(WANTS)
  subcategories   String[]           @default([])
  isActive        Boolean            @default(true)
  isSystem        Boolean            @default(false)
  displayOrder    Int                @default(0)

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@index([budgetType])
}

model ExpenseCategoryRule {
  id                String   @id @default(cuid())
  userId            String
  name              String
  isActive          Boolean  @default(true)
  priority          Int      @default(0) // Higher = checked first

  // Matching conditions stored as JSON
  // Format: [{ field, operator, value }]
  conditions        Json

  // Actions when rule matches
  targetCategory    String
  targetSubcategory String?
  applyTags         String[] @default([])

  // Stats
  timesApplied      Int      @default(0)
  lastAppliedAt     DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([priority])
}

model AlertPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  budgetAlerts      Boolean  @default(true)
  overspendAlerts   Boolean  @default(true)
  alertThreshold    Int      @default(80) // Percentage trigger (e.g., 80%)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AlertDelivery {
  id              String   @id @default(cuid())
  userId          String
  alertType       String   // BUDGET_WARNING, OVERSPEND, GOAL_PROGRESS
  category        String   // needs, wants, savings, or specific category
  percentage      Float
  message         String
  isRead          Boolean  @default(false)

  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

// ============================================================================
// NON-SALARY INCOME MODELS
// ============================================================================

// Business Income - Section 44AD/44ADA Presumptive Taxation
model BusinessIncome {
  id                String   @id @default(cuid())
  userId            String
  fiscalYear        String   // "2024-25"
  businessName      String
  businessType      String   // "PROPRIETORSHIP", "PARTNERSHIP", "LLP"
  taxationScheme    String   // "44AD", "44ADA", "REGULAR"
  natureOfBusiness  String?  // "TRADING", "MANUFACTURING", "PROFESSIONAL", etc.
  grossReceipts     Float
  digitalPaymentPct Float    @default(50)
  deemedProfitRate  Float    // 8%, 6%, or 50%
  taxableProfit     Float
  gstRegistered     Boolean  @default(false)
  gstNumber         String?
  gstFilingFreq     String?  // "MONTHLY", "QUARTERLY"
  pan               String?

  // For 5-year lock-in tracking
  schemeStartYear   String?  // First year of 44AD/44ADA adoption
  yearsOnScheme     Int      @default(1)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([taxationScheme])
}

// Rental Income - House Property with Section 24 Deductions
model RentalIncome {
  id                  String    @id @default(cuid())
  userId              String
  fiscalYear          String
  propertyId          String?   // Link to Property in investments (optional)
  propertyName        String
  propertyAddress     String?
  propertyType        String    // "RESIDENTIAL", "COMMERCIAL", "LAND"
  ownershipType       String    @default("SELF") // "SELF", "JOINT", "HUF"

  // Rental Details
  grossAnnualRent     Float
  monthlyRent         Float?
  vacantMonths        Int       @default(0)
  municipalTaxes      Float     @default(0)

  // Section 24 Deductions
  netAnnualValue      Float     // GAV - Municipal Taxes
  standardDeduction   Float     // 30% of NAV
  housingLoanInterest Float     @default(0)
  preConstructionInt  Float     @default(0) // 1/5th per year for 5 years
  preCnstIntStartYear String?   // Year when pre-construction interest started
  taxableIncome       Float

  // Tenant Details
  tenantName          String?
  tenantPan           String?
  tenantStartDate     DateTime?
  rentAgreementExpiry DateTime?

  // Co-owners (JSON array)
  coOwners            Json?     // [{name, pan, percentage, share}]
  ownershipPercent    Float     @default(100)

  // Loan Details
  loanAccountNumber   String?
  lenderName          String?
  loanSanctionDate    DateTime?
  possessionDate      DateTime?
  isSelfOccupied      Boolean   @default(false)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([propertyType])
}

// Capital Gains - STCG/LTCG with Budget 2024 Rules
model CapitalGain {
  id                  String    @id @default(cuid())
  userId              String
  fiscalYear          String

  // Asset Details
  assetType           String    // "EQUITY", "EQUITY_MF", "DEBT_MF", "PROPERTY", "GOLD", "CRYPTO", "OTHER"
  assetName           String
  assetDescription    String?
  quantity            Float?

  // Transaction Details
  purchaseDate        DateTime
  purchasePrice       Float
  saleDate            DateTime
  salePrice           Float
  expenses            Float     @default(0) // Brokerage, stamp duty, etc.

  // Holding & Classification
  holdingPeriodMonths Int
  gainType            String    // "STCG", "LTCG"

  // Indexation (for LTCG on property/gold/debt MF before April 2023)
  purchaseCII         Int?      // Cost Inflation Index for purchase year
  saleCII             Int?      // Cost Inflation Index for sale year
  indexedCost         Float?
  useIndexation       Boolean   @default(false)

  // Tax Calculation
  grossGain           Float     // Sale - Purchase - Expenses (or - IndexedCost)
  exemptionSection    String?   // "54", "54F", "54EC", "54B"
  exemptionAmount     Float     @default(0)
  taxableGain         Float
  taxRate             Float     // 12.5%, 20%, 30% (crypto), slab rate
  estimatedTax        Float

  // For LTCG choice (property bought before July 2024)
  isPreJuly2024       Boolean   @default(false)
  taxWithIndexation   Float?    // 20% + CII calculation
  taxWithoutIndex     Float?    // 12.5% flat calculation
  recommendedOption   String?   // "WITH_INDEX" or "WITHOUT_INDEX"

  // Broker Import
  brokerName          String?
  brokerOrderId       String?
  importedFrom        String?   // "ZERODHA", "GROWW", "UPSTOX", "MANUAL"

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([assetType])
  @@index([gainType])
}

// Interest Income - FD, RD, Savings, P2P, Bonds
model InterestIncome {
  id                String    @id @default(cuid())
  userId            String
  fiscalYear        String

  // Source Details
  sourceType        String    // "FD", "RD", "SAVINGS", "P2P", "BONDS", "NSC", "SCSS", "PPF", "OTHER"
  institutionName   String
  accountNumber     String?
  branchName        String?

  // Interest Details
  principalAmount   Float?
  interestRate      Float?
  interestEarned    Float
  accruedInterest   Float?    // For bonds/debentures

  // TDS
  tdsDeducted       Float     @default(0)
  tdsRate           Float?
  form16AReceived   Boolean   @default(false)

  // Maturity (for FD/RD)
  depositDate       DateTime?
  maturityDate      DateTime?
  maturityAmount    Float?
  tenureMonths      Int?
  isAutoRenew       Boolean   @default(false)

  // 80TTA/80TTB Eligibility
  is80TTAEligible   Boolean   @default(false) // Savings account interest
  is80TTBEligible   Boolean   @default(false) // Senior citizen (60+)
  deductionClaimed  Float     @default(0)

  // For P2P Lending
  platformName      String?
  borrowerCount     Int?
  defaultAmount     Float?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([sourceType])
  @@index([maturityDate])
}

// Dividend Income - Stocks & Mutual Funds
model DividendIncome {
  id                String    @id @default(cuid())
  userId            String
  fiscalYear        String

  // Source Details
  sourceType        String    // "STOCK", "MUTUAL_FUND", "REIT", "INVIT"
  companyOrFundName String
  symbol            String?
  isin              String?
  folioNumber       String?

  // Dividend Details
  dividendType      String?   // "INTERIM", "FINAL", "SPECIAL"
  recordDate        DateTime?
  exDividendDate    DateTime?
  paymentDate       DateTime
  dividendPerShare  Float?
  numberOfShares    Float?
  dividendAmount    Float

  // TDS (10% above Rs 5,000)
  tdsDeducted       Float     @default(0)
  tdsRate           Float?

  // For yield calculation
  investmentValue   Float?    // Market value of holding
  dividendYield     Float?    // Annual yield %

  // Source tracking
  dematAccount      String?
  brokerName        String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([sourceType])
  @@index([paymentDate])
}

// Other Income - Commission, Royalties, Gifts, Lottery, Pension, Agricultural
model OtherIncome {
  id                String    @id @default(cuid())
  userId            String
  fiscalYear        String

  // Income Details
  category          String    // "COMMISSION", "ROYALTY", "PENSION", "GIFT", "LOTTERY", "AGRICULTURAL", "FAMILY_PENSION", "OTHER"
  description       String
  sourceName        String?   // Payer name
  sourcePan         String?

  // Amount
  grossAmount       Float
  tdsDeducted       Float     @default(0)
  netAmount         Float?

  // Category-specific fields

  // Commission
  isRegular         Boolean   @default(false) // Regular = 44AD eligible, Occasional = Other sources
  commissionType    String?   // "INSURANCE", "REAL_ESTATE", "MLM", "REFERRAL", "OTHER"

  // Gift
  giftDate          DateTime?
  donorRelationship String?   // "RELATIVE", "NON_RELATIVE" (>50K from non-relative is taxable)
  isFromRelative    Boolean   @default(false)
  isExempt          Boolean   @default(false)

  // Lottery/Game Show
  gameShowName      String?
  winningDate       DateTime?
  flatTaxRate       Float?    // 30% for lottery/game show

  // Pension
  pensionType       String?   // "COMMUTED", "UNCOMMUTED", "FAMILY"
  pensionerName     String?

  // Agricultural (exempt but for rate purposes)
  landLocation      String?
  cropType          String?

  // Royalty
  royaltyType       String?   // "BOOK", "MUSIC", "PATENT", "SOFTWARE"

  receiptDate       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, fiscalYear])
  @@index([category])
}

// ============================================================================
// PROTECTION/INSURANCE MODELS
// ============================================================================

enum InsuranceType {
  LIFE
  HEALTH
  MOTOR
  HOME
  TRAVEL
}

enum InsurancePolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum InsurancePaymentFrequency {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

enum TaxBenefitType {
  SECTION_80C
  SECTION_80D
  BOTH
  NONE
}

model InsurancePolicy {
  id                    String                    @id @default(cuid())
  userId                String
  familyMemberId        String?

  // Policy basics
  policyNumber          String
  policyName            String
  type                  InsuranceType
  provider              String
  status                InsurancePolicyStatus     @default(ACTIVE)

  // Coverage
  sumAssured            Float
  premium               Float
  paymentFrequency      InsurancePaymentFrequency

  // Dates
  startDate             DateTime
  endDate               DateTime
  nextDueDate           DateTime?
  lastPremiumPaidDate   DateTime?

  // Life insurance specific
  maturityDate          DateTime?
  maturityAmount        Float?
  surrenderValue        Float?
  loanAvailable         Boolean                   @default(false)
  loanAmount            Float?

  // Health insurance specific
  coverType             String?                   // individual, family, floater
  roomRentLimit         Float?
  copayPercent          Float?
  waitingPeriod         Int?                      // days
  preExistingWaiting    Int?                      // years
  networkHospitals      Int?                      // count

  // Motor insurance specific
  vehicleNumber         String?
  vehicleType           String?                   // car, bike, commercial
  vehicleModel          String?
  idvValue              Float?                    // Insured Declared Value
  ncbPercent            Float?                    // No Claim Bonus

  // Home insurance specific
  propertyType          String?                   // apartment, house, commercial
  propertyAddress       String?
  propertyValue         Float?
  contentsCover         Float?

  // Tax benefits
  taxBenefit            TaxBenefitType?

  // Additional details
  policyDocument        String?                   // URL to uploaded document
  notes                 String?

  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  // Relations
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  nominees              InsuranceNominee[]

  @@index([userId])
  @@index([userId, type])
  @@index([userId, status])
  @@index([endDate])
}

model InsuranceNominee {
  id                String           @id @default(cuid())
  policyId          String

  name              String
  relationship      String
  dateOfBirth       DateTime?
  sharePercent      Float            @default(100)
  isMinor           Boolean          @default(false)
  appointeeName     String?          // Required if nominee is minor
  appointeeRelation String?
  phone             String?
  isPrimary         Boolean          @default(true)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  policy            InsurancePolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([policyId])
}

// ============================================================================
// TAX PLANNING MODELS
// ============================================================================

// Advance Tax Estimate - Track quarterly advance tax obligations
model AdvanceTaxEstimate {
  id                    String   @id @default(cuid())
  userId                String
  financialYear         String   // "2024-25"
  selectedRegime        String   @default("NEW") // "OLD" | "NEW"
  totalEstimatedIncome  Float    @default(0)
  incomeBreakdown       Json?    // { salary, business, rental, capitalGains, other }
  estimatedDeductions   Float    @default(0)
  totalTDSDeducted      Float    @default(0)
  grossTaxLiability     Float    @default(0)
  netTaxLiability       Float    @default(0)
  advanceTaxRequired    Boolean  @default(false) // True if > 10,000
  interest234B          Float    @default(0)
  interest234C          Float    @default(0)
  lastCalculatedAt      DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules             AdvanceTaxSchedule[]
  payments              AdvanceTaxPayment[]

  @@unique([userId, financialYear])
  @@index([userId])
}

// Advance Tax Schedule - Quarterly due dates and payment tracking
model AdvanceTaxSchedule {
  id                    String   @id @default(cuid())
  estimateId            String
  quarter               Int      // 1, 2, 3, 4
  dueDate               DateTime // Jun 15, Sep 15, Dec 15, Mar 15
  cumulativePercentage  Float    // 15, 45, 75, 100
  cumulativeAmountDue   Float    @default(0)
  quarterAmountDue      Float    @default(0)
  amountPaid            Float    @default(0)
  shortfall             Float    @default(0)
  status                String   @default("PENDING") // PENDING, PAID, PARTIAL, OVERDUE
  interest234C          Float    @default(0)

  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  payments              AdvanceTaxPayment[]

  @@unique([estimateId, quarter])
  @@index([estimateId])
  @@index([dueDate])
}

// Advance Tax Payment - Individual payment records with challan details
model AdvanceTaxPayment {
  id                    String   @id @default(cuid())
  userId                String
  estimateId            String
  scheduleId            String?
  paymentDate           DateTime
  amount                Float
  challanSerialNumber   String
  bsrCode               String
  bankName              String?
  quarter               Int      // 1, 2, 3, 4
  financialYear         String
  isVerified            Boolean  @default(false)
  challanDocumentUrl    String?
  notes                 String?
  createdAt             DateTime @default(now())

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  estimate              AdvanceTaxEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  schedule              AdvanceTaxSchedule? @relation(fields: [scheduleId], references: [id])

  @@index([userId, financialYear])
  @@index([estimateId])
}

// Tax What-If Scenario - Saved scenarios for tax planning comparison
model TaxWhatIfScenario {
  id                      String   @id @default(cuid())
  userId                  String
  financialYear           String
  name                    String
  description             String?
  isBaseline              Boolean  @default(false) // Baseline scenario (current state)
  isAutoGenerated         Boolean  @default(false) // Smart suggestion generated
  selectedRegime          String   // 'OLD' | 'NEW'

  // Adjustments stored as JSON
  incomeAdjustments       Json     @default("{}") // { salary: 100000, business: 50000, ... }
  deductionAdjustments    Json     @default("{}") // { section80C: 150000, section80D: 25000, ... }

  // Calculated values
  totalGrossIncome        Float    @default(0)
  totalDeductions         Float    @default(0)
  taxableIncome           Float    @default(0)
  totalTaxLiability       Float    @default(0)
  taxDifferenceFromBaseline Float  @default(0) // Negative = savings
  percentageSavings       Float    @default(0)

  // Smart suggestion metadata
  suggestionReason        String?  // Why this scenario was suggested
  optimizationCategory    String?  // MAX_80C, MAX_NPS, REGIME_SWITCH, COMBINED_OPTIMAL

  lastCalculatedAt        DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, financialYear, name])
  @@index([userId, financialYear])
  @@index([isBaseline])
}
